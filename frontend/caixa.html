<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Rota 600 - Admin/Caixa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #121212; color: #e0e0e0; }
        .mesa-card { border-radius: 12px; cursor: pointer; min-height: 120px; transition: 0.2s; border: none; }
        .vazia { background: #1e3a8a; } /* Azul */
        .consumindo { background: #064e3b; } /* Verde */
        .fechada { background: #7f1d1d; } /* Vermelho */
        .modal-content { background: #1e1e1e; color: white; border: 1px solid #333; }
        .list-group-item { background: #2a2a2a; color: white; border-color: #444; }
    </style>
</head>
<body class="p-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üçª Rota 600 - Dashboard</h2>
        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalEstoque">üì¶ Gerenciar Produtos</button>
    </div>

    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3" id="gridMesas"></div>

    <div class="modal fade" id="modalMesa" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 id="tituloMesa">Mesa</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body row">
                    <div class="col-md-6 border-end">
                        <h6>Comanda Atual</h6>
                        <ul id="listaItens" class="list-group mb-3"></ul>
                        <h4 id="totalMesa" class="text-success">Total: R$ 0,00</h4>
                    </div>
                    <div class="col-md-6">
                        <h6>Lan√ßar Produto</h6>
                        <div id="botoesProdutos" class="d-grid gap-2"></div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button class="btn btn-danger" id="btnFechar">Solicitar Pagamento (Vermelho)</button>
                    <button class="btn btn-warning" id="btnLiberar">Finalizar e Liberar (Azul)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEstoque" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Cadastro de Produtos</h5></div>
                <div class="modal-body">
                    <form id="formProd" class="row g-2 mb-3">
                        <div class="col-7"><input id="n" class="form-control" placeholder="Nome" required></div>
                        <div class="col-3"><input id="p" type="number" step="0.01" class="form-control" placeholder="R$" required></div>
                        <div class="col-2"><button class="btn btn-primary w-100">+</button></div>
                    </form>
                    <ul id="listaEstoque" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Inicializa√ß√£o √∫nica do Socket
        const socket = io(); 
        let mesaAtual = null;
        let prodsCache = [];
        const modalMesa = new bootstrap.Modal(document.getElementById('modalMesa'));

        // Escutar atualiza√ß√£o das mesas
        socket.on('atualizarMesas', (mesas) => {
            const grid = document.getElementById('gridMesas');
            grid.innerHTML = mesas.map(m => `
                <div class="col" onclick="abrirMesa(${m.id}, '${m.status}', ${m.consumo})">
                    <div class="p-3 mesa-card ${m.status} text-center shadow">
                        <div class="fw-bold">Mesa ${m.id}</div>
                        <div class="fs-5">R$ ${m.consumo.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        });

        // Escutar atualiza√ß√£o dos produtos
        socket.on('atualizarProdutos', (prods) => {
            prodsCache = prods;
            document.getElementById('listaEstoque').innerHTML = prods.map(p => `
                <li class="list-group-item d-flex justify-content-between">
                    ${p.nome} <span>R$ ${p.preco.toFixed(2)}</span>
                </li>`).join('');
        });

        function abrirMesa(id, status, consumo) {
            mesaAtual = id;
            document.getElementById('tituloMesa').innerText = "Mesa " + id;
            document.getElementById('totalMesa').innerText = "Total: R$ " + consumo.toFixed(2);
            socket.emit('getDetalhes', id);
            
            document.getElementById('botoesProdutos').innerHTML = prodsCache.map(p => `
                <button class="btn btn-outline-info text-start" onclick="lancar('${p.nome}', ${p.preco})">${p.nome}</button>
            `).join('');
            
            modalMesa.show();
        }

        // Atualizar lista da comanda dentro do modal
        socket.on('detalhesMesa', (d) => {
            if(d.mesaId == mesaAtual) {
                document.getElementById('listaItens').innerHTML = d.itens.map(i => `
                    <li class="list-group-item d-flex justify-content-between">
                        <span>${i.produto_nome}</span>
                        <span>R$ ${i.valor.toFixed(2)}</span>
                    </li>`).join('');
            }
        });

        function lancar(nome, preco) { 
            socket.emit('lancarItem', { mesaId: mesaAtual, nome, preco }); 
        }
        
        // Bot√£o Vermelho (Fechar Conta)
        document.getElementById('btnFechar').onclick = () => {
            socket.emit('alterarStatus', { id: mesaAtual, status: 'fechada' });
        };

        // Bot√£o Amarelo (Zerar e Liberar)
        document.getElementById('btnLiberar').onclick = () => { 
            if(confirm("Zerar conta e liberar mesa?")) {
                socket.emit('alterarStatus', { id: mesaAtual, status: 'vazia' }); 
                modalMesa.hide(); 
            }
        };

        // Cadastro de novos produtos
        document.getElementById('formProd').onsubmit = (e) => {
            e.preventDefault();
            const nome = document.getElementById('n').value;
            const preco = parseFloat(document.getElementById('p').value);
            socket.emit('criarProduto', { nome, preco, estoque: 999 });
            e.target.reset();
        };
    </script>
</body>
</html>